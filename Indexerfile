FROM golang:1.22.3

# install packages
RUN apt-get update && \
    apt-get install -y g++ wget

WORKDIR /app

# Download Llamafile
RUN wget -O /app/llamafile.exe https://github.com/Mozilla-Ocho/llamafile/releases/download/0.8.6/llamafile-0.8.6 && \
chmod +x /app/llamafile.exe

# Download the Hugging Face model
RUN wget -O /app/nomic.gguf https://huggingface.co/nomic-ai/nomic-embed-text-v1.5-GGUF/resolve/main/nomic-embed-text-v1.5.Q8_0.gguf

# default vars that can be overridden
ENV EMBEDDER_URL=http://localhost:8080
ENV EMBEDDER_CTX=2040
ENV INSTANCE_MODE=INDEXER
ENV SITEMAPS_FILE=./sitemaps.csv
ENV COLLECTION_SCHEDULE="0 * * * * *"
ENV CLEANUP_SCHEDULE="0 0 0 * * 0"

# Build the go code
COPY . .
RUN go get
RUN go build -o indexer .

# Start Llamafile in the background
RUN /app/llamafile.exe -m /app/nomic.gguf --server --nobrowser --embedding -c 0 &
ENTRYPOINT [ "/app/indexer" ]
